<!DOCTYPE html>

<html>

  <head>
    <meta charset="UTF-8">

  </head>

  <body scroll="no" style="background: #000;">

    <div style="position: fixed; left: 0; top: 0; margin: 0; padding: 0; height: 100%; width: 100%; display: flex; justify-content: center; align-items: center;"><canvas width=512 height=512 id="canvas"></div>

    <!-- GLSL -->

    <script id="vertexShader" type="x-shader/x-vertex">
      attribute vec3 aVertexCoords;
      attribute vec2 aTextureCoords;

      uniform mat4 uMVMatrix;
      uniform mat4 uProjMatrix;

      varying highp vec2 vTextureCoords;
      varying highp vec2 vPosition;

      void main(void){
        uProjMatrix;
        uMVMatrix;
        gl_Position = vec4(aVertexCoords.xy, 0.0, 1.0);
        vTextureCoords = aTextureCoords;
        vPosition = aVertexCoords.xy;
      }
    </script>

    <script id="fragmentShader" type="x-shader/x-fragment">
      precision mediump float;
      uniform sampler2D uSampler;
      uniform vec3 uLightPosition;
      varying highp vec2 vTextureCoords;
      varying highp vec2 vPosition;

      void main(void){
        lowp vec4 texColor = vec4(texture2D(uSampler, vec2(vTextureCoords.s, vTextureCoords.t)));
        if (texColor.a == 0.0){ discard; }
        highp vec4 reading = texture2D(uSampler, vTextureCoords);
        highp vec3 position = vec3(vPosition * 2.0 - 1.0, -1.0);
        highp vec3 normal = vec3(texture2D(uSampler, vec2(vTextureCoords.s + 0.5, vTextureCoords.t)).rgb);
        highp vec3 lightDirection = vec3(uLightPosition.xyz - position);
        highp float distance = length(lightDirection);
        lowp vec3 lightColor = vec3(1.2, 0.8, 0.5);
        highp float light = dot(normalize(lightDirection), normalize(normal));
        distance = max(distance, 0.0);
        light = step(0.7, light) / pow(distance, 2.0);
        light = min(light, 0.8);
        lowp vec3 color = mix(lightColor, texColor.xyz, 1.0 - light);
        gl_FragColor = vec4 (color, texColor.a);
      }
    </script>

    <!-- END GLSL -->



    <script src = "../globals.js"></script>
    <script src = "../helpers/limit.js"></script>
    <script src = "../libraries/arrayVec3D.js"></script>
    <script src = "../systems/geometry/geometry.js"></script>
    <script src = "../libraries/matrix.js"></script>
    <script src = "../libraries/webgl_utils.js"></script>
    <script src = "../systems/graphics/dynamic-lighting/point-light.js"></script>



    <script>

      var LIGHT_COLOR = [255,240,200],
        IMAGE_SRC = 'herocombi3.png',
        NORMALS_SRC = '../assets/hero_standing_left_map.png',
        canvas = document.getElementById("canvas"),
        controller = document.getElementById("controller");

      var glProgram = new WebGLProgram(canvas, "vertexShader", "fragmentShader");
      glProgram.use();
      console.log(glProgram);
      glProgram.bindDataToAttribute("aVertexCoords", [
        -1.0, -1.0,  -3.0,
         1.0, -1.0,  -3.0,
         1.0,  1.0,  -3.0,
        -1.0,  1.0,  -3.0,], 3);
      glProgram.bindDataToAttribute("aTextureCoords", [
        0.0,  1.0,
        0.5,  1.0,
        0.5,  0.0,
        0.0,  0.0], 2);
      glProgram.setMat4Uniform("uProjMatrix", glProgram.projectionMatrix);
      glProgram.setMat4Uniform("uMVMatrix", glProgram.mvMatrix);
      glProgram.setIntUniform("uSampler", 0);
      glProgram.setVec3Uniform("uLightPosition", [0.0, 0.0]);

      var gl = glProgram.gl;

      var texture = gl.createTexture();
      var texImage = new Image(256, 256);
      texImage.onload = function(){
        gl.bindTexture(gl.TEXTURE_2D, texture);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, texImage);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_NEAREST);
        gl.generateMipmap(gl.TEXTURE_2D);

        // gl.uniform1i(uSampler, 0);

        gl.activeTexture(gl.TEXTURE0);
        gl.bindTexture(gl.TEXTURE_2D, texture);

        requestAnimationFrame(draw);
      }
      texImage.src = IMAGE_SRC;

      var lightPos = [0.0, 0.0, 3.0, 1.0];

      function draw(){
        // console.log(lightPos);
        // glProgram.setVec3Uniform("uLightPosition", lightPos);
        gl.clear(glProgram.gl.COLOR_BUFFER_BIT);
        gl.drawArrays(glProgram.gl.TRIANGLE_FAN, 0, 4);
        // lightPos = Mat4.Rotation(0.0, 0.1, 0.0).timesVec4(lightPos);


        requestAnimationFrame(draw);
      }

      function setLight(x,y){
        x -= canvas.offsetLeft;
        y -= canvas.offsetTop;
        console.log([x,y]);
        x = (x / 512 * 2.0) - 1.0;
        y = (y / 512 * 2.0) - 1.0;
        z = -Math.max(1.0 - ArrayVec3D.length([x,y,0]), 0.3);
        glProgram.setVec3Uniform("uLightPosition", [x,-y,z]);
      }

      window.addEventListener('mousemove', function(e){
        setLight(e.clientX, e.clientY);
      });

      window.addEventListener('touchstart', function(e){
        e.preventDefault();
        if (e.touches.length == 1) {
          setLight(e.touches.item(0).clientX, e.touches.item(0).clientY);
        }
      });

      window.addEventListener('touchmove', function(e){
        e.preventDefault();
        if (e.touches.length == 1) {
          setLight(e.touches.item(0).clientX, e.touches.item(0).clientY);
        }
      });

    </script>


  </body>

</html>