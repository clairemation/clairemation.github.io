<html>
  <head>
    <link type="text/css" rel="stylesheet" href="art.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">

    <title>clairemation's art</title>
  </head>
  <body>

    <div id="content">
      <h1>clairemation's art</h1>

      <p>Select category tags to view. Select multiple tags to find images that match <em>all</em> of those tags. Select nothing to show all images.</p>
      <div id = "selectable-tags"></div>
      <fieldset>
        <legend>Display order:</legend>
        <input type="radio" id="date-descending" name="order" value="1" checked />
        <label for="date-descending">Newest to oldest</label>
        <input type="radio" id="date-ascending" name="order" value="0" />
        <label for="date-ascending">Oldest to newest</label>
      </fieldset>
      <button id="show-button">Show</button>

      <div><ul id="art-display"></ul></div>

    </div>

    <div id="modal-background" class="hidden" onclick="this.className = 'hidden'">
      <p id="modal"></p>
    </div>


    <script>
      const tagSelectionHtmlElement = document.getElementById("selectable-tags")
      let modalBackground = document.getElementById("modal-background")
      let modalText = document.querySelector("p#modal");

      let tagSelectionOptionHtmlElements;

      let imageDatas;
      let allTags;

      let sortFunction = sortNewestToOldest;

      document.querySelector("input#date-ascending").onclick = e => sortFunction = sortOldestToNewest;
      document.querySelector("input#date-descending").onclick = e => sortFunction = sortNewestToOldest;

      fetch("manifest.json")
        .then(response => response.json())
        .then(data => {
          const {mapOfTagTypeToTagInfosSet, imageInfos} = processManifest(data);
          imageDatas = imageInfos;
          allTags = Array.prototype.flatMap.call([...mapOfTagTypeToTagInfosSet.values()], e => e);

          renderTagSelectionHtml(mapOfTagTypeToTagInfosSet);

          const allTagTooltips = document.querySelectorAll(".tag-tooltip");
          allTagTooltips.forEach(tooltip => tooltip.addEventListener("click", displayTagDescription));

          tagSelectionOptionHtmlElements = document.querySelectorAll("#selectable-tags input");
          document.getElementById('show-button').onclick = displayImagesWithSelectedTags;
        })

      function processManifest(manifest) {
        const tags = manifest.tags;
        const images = manifest.images;

        const tagSetsByTagType = Map.groupBy(tags, tag => tag.type)

        images.forEach(imageDataItem => imageDataItem.tags = new Set(imageDataItem.tags))

        return {
            mapOfTagTypeToTagInfosSet: tagSetsByTagType, imageInfos: images
        }
      }

      function renderTagSelectionHtml(mapOfTagTypeToTagInfosSet) {
        const tagSelectorHtmlElementStrings = mapOfTagTypeToTagInfosSet.entries().map(tagTypeAndTagInfosSetPair => {
          const tagType = tagTypeAndTagInfosSetPair[0];
          const tagInfosSet = tagTypeAndTagInfosSetPair[1];

          const tagNameOptionsHtmlString = tagInfosSet.map(tagInfo => {
            const infoButtonHtml = tagInfo.description ?
                    `<span class="tag-tooltip" data-description="${tagInfo.description}">&#9432;</span>`
                    : ''

            return `
            <div class="option">
                <input type='checkbox' value='${tagInfo.name}' id='input-${tagInfo.name}' />
                <label for='input-${tagInfo.name}'>${tagInfo.name}</label>
                ${infoButtonHtml}
            </div>`
          }).join('');

          return `
                <fieldset>
                  <legend>${tagType}</legend>
                      <div class="options">${tagNameOptionsHtmlString}</div>
                </fieldset>
            `
        })

        const selector = document.createElement('div')
        selector.innerHTML = tagSelectorHtmlElementStrings.toArray().join('');
        tagSelectionHtmlElement.appendChild(selector);

        return selector
      }

      function displayImagesWithSelectedTags() {
        const selectedTagSet = getSelectedTagSet();
        const selectedImages = imageDatas.filter(imageData => imageData.tags.isSupersetOf(selectedTagSet));

        const imageHtmlElements = selectedImages.sort(sortFunction)
          .map(imageData => {
            const tagListHtmlString = imageData.tags.keys().map(tag => `<span class="image-tag" onclick="navigateToTag('${tag}')">${tag}</span>`).toArray().join(' ')

            return `
              <li>
                  <a href="scaled/${imageData.relativeFilePath}"><img src="thumbnails/${imageData.relativeFilePath}"/></a>
                  <p class="image-title">${imageData.title}</p>
                  <p class="image-year">${imageData.dateCreated.toString().slice(0,4)}</p>
                  <p class="image-description">${imageData.description || ''}</p>
                  <p class="image-tag-list">${tagListHtmlString}</p>
              </li>`
          });

        document.querySelector("#art-display").innerHTML =
                selectedImages.length === 0 ?
                        `<p style="font-size: medium;">No images found matching all your selected tags. Try removing some tags to broaden your search.</p>` :
                        imageHtmlElements.join("");
      }

      function sortOldestToNewest(a, b)
      {
        return a.dateCreated - b.dateCreated;
      }

      function sortNewestToOldest(a, b)
      {
        return b.dateCreated - a.dateCreated;
      }

      function getSelectedTagSet() {
        let selectedOptionElementValues = Array.prototype.filter.call(tagSelectionOptionHtmlElements, element => element.checked)
                .map(element => element.value)
                .filter(Boolean)
        return new Set(selectedOptionElementValues)
      }

      function navigateToTag(tag)
      {
        selectTag(tag);
        displayImagesWithSelectedTags();
      }

      function selectTag(tag) {
        Array.prototype.forEach.call(tagSelectionOptionHtmlElements, option => {
          option.selected = option.value === tag;
        })
      }

      function displayTagDescription(event)
      {
        modalBackground.className = "shown";
        modalText.innerHTML = event.target.dataset.description;
        modalText.style.left = event.clientX;
        modalText.style.top = event.clientY;
      }


    </script>
  </body>
</html>