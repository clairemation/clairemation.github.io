<!DOCTYPE html>

<html>

  <head>

    <title>Mementos: A Star Wars Fancomic by Clairemation</title>

    <style>

      p {
        font-size: 1.25em;
        font-family: sans-serif;
      }

      #page-holder.scale-to-height .page{
        height: 100%;
        width: auto;
      }

      #page-holder.scale-to-width .page{
        flex: 1;
        height: auto;
      }
       
      #page-holder.scale-to-width.spread .page {
        width: 50%;
      }

      #page-holder.scale-to-width.single-page .page{
        width: 100%;
      }

      #slidecontainer {
        width: 100%;
      }

      #slider {
        -webkit-appearance: none;
        width: 100%;
        height: 10px;
        background: #fff;
        outline: none;
        /*border-radius: 15%;*/
      }

      #slider:hover {
        opacity: 1;
      }

      #slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 35px;
        height: 35px;
        border: 5px solid #444;
        border-radius: 50%;
        background: #999;
      }

      #slider::-moz-range-thumb {
        width: 25px;
        height: 25px;
        background: #4CAF50;
      }

    </style>

  </head>

  <body style = "text-align: center; background-color: #000; color: #fff; font-face: sans-serif;">

    <div id="container" style="position: absolute; left: 0; top: 0; width: 100%; height: 100%; display: flex; flex-direction: column; ">

  		<div id = "page-holder" style = "position: relative; display: flex; flex-direction: row; align-content: center; align-items: center; justify-content: center; text-align: center; height: 100%; flex-shrink: 1;">

        <div id="nav-links" style="position: absolute; width: 100%; height: 100%;">
          <a id="prev-link"><div style="position: absolute; left: 0; top: 0; width: 50%; height: 100%;"> </div></a>
          <a id="next-link"><div style="position: absolute: right: 0; top: 0; width: 50%; height: 100%;"> </div></a>
        </div>

  		</div>

    		<div id="slidecontainer" style = "display:flex; flex-direction: row; align-items: center; justify-content: center; text-align: center; width: 100%; height: 100px;">
    		  <span id ="slider-output" style = "width: 10%; font-size: 1.25em; font-face: sans-serif;">1</span>
  		    <input id="slider" type="range" min="1" max="40" value="1" class="slider" style= "-webkit-appearance: none; appearance: none; background: #fff; width: 80%;">
      		<div id = "displaybutton-holder" style = "display:flex; flex-direction: row; align-items: center; justify-content: center; text-align: center; height: 50px; width: 10%;">
      			<a id="display-button-anchor"><button id="display-button"></button></a>
      		</div>
    		</div>

    </div>


  	<script>

      const pageHolder = document.getElementById("page-holder")
      const slider = document.getElementById("slider")
      const sliderOutput = document.getElementById("slider-output")
      const goPageButton = document.getElementById("go-page-button")

  		const params = new URLSearchParams(window.location.search)
  		const basePageNum = parseInt(params.get("page")) || 1

  		const pageMin = 1, PageMax = 40
  		const pageRatio = 1350 / 1800
  		const spreadRatio = 1350 * 2 / 1800

  		function windowRatio()
      {
        return pageHolder.clientWidth / pageHolder.clientHeight
      }

  		function windowIsWiderThanSinglePage()
      {
        return windowRatio() >= pageRatio
      }
  		
      function windowIsWiderThanSpread()
      {
        return windowRatio() >= spreadRatio
      }

  		const BUTTON_HEIGHT = 100

  		var isSpread, pageStart, pageEnd

      init()
      initNavButtons()
      initDisplayButton()
      createPages()
      initSlider()
      setPageHolderClass()

      var resizeTimeout
      window.onresize = () => {
        clearTimeout(resizeTimeout)
        resizeTimeout = setTimeout(setPageHolderClass, 100)
      }

      function init()
      {
    		if (params.has("spread"))
    		{
     			isSpread = params.get("spread") == "true" || false
    		}
    		else {
    			isSpread = windowIsWiderThanSpread()
    		}
      }

      function initDisplayButton()
      {
        document.getElementById("display-button-anchor").href = createParamString(getParams({isSpread: !isSpread}))
        document.getElementById("display-button").innerHTML = isSpread ? "Display: single page" : "Display: spread"
      }

      function windowIsWiderThanLayout()
      {
        return (isSpread && (windowIsWiderThanSpread())) || (!isSpread && windowIsWiderThanSinglePage())
      }

      function createPages()
      {
    		if (isSpread)
    		{
    			if (basePageNum % 2 == 0)
    			{
    				pageStart = basePageNum
    				pageEnd = basePageNum + 1
    			}
    			else {
    				pageStart = basePageNum - 1
    				pageEnd = basePageNum
    			}
    		}
    		else {
    			pageStart = pageEnd = basePageNum
    		}

    		for (var i = pageStart; i <= pageEnd; i++)
    		{
    			pageHolder.appendChild(createPage(i))
    		}
      }

      function initSlider()
      {
    		if (isSpread)
    		{
    			slider.min = 0
    			slider.max = PageMax / 2
    			slider.value = pageStart / 2
    			if (slider.value == 0)
    			{
    				sliderOutput.innerHTML = getPageDisplayNum(pageEnd)
    			} else {
  	  			sliderOutput.innerHTML = getPageDisplayNum(pageStart) + "-" + getPageDisplayNum(pageEnd)
  	  		}
    		}
    		else {
    			slider.min = 1
    			slider.max = PageMax
    			slider.value = basePageNum
    			sliderOutput.innerHTML = getPageDisplayNum(basePageNum)
    		}

        slider.oninput = isSpread ? updateSliderValueSpread : updateSliderValueSinglePage
        slider.onmouseup = (() => {
          var pageNum = isSpread ? slider.value * 2 : slider.value
          window.location.href = createParamString(getParams({setPage: pageNum}))
        })
      }

  		function updateSliderValueSpread()
  		{
  			var value = slider.value * 2
  			if (value == 0){
  				sliderOutput.innerHTML = getPageDisplayNum(value + 1)
  			} else {
  			sliderOutput.innerHTML = getPageDisplayNum(value) + "-" + getPageDisplayNum(value + 1)
	  		}
  		}

  		function updateSliderValueSinglePage()
  		{
  			var value = slider.value
  			sliderOutput.innerHTML = getPageDisplayNum(value)
  		}

  		function getPageDisplayNum(num)
  		{
  			if (num <=4)
  			{
  				return (["", "i", "ii", "cover", "note"])[num]
  			}
  			else {
  				return (num - 4).toString()
  			}
  		}

      function initNavButtons()
      {
    		var increment = isSpread ? 2 : 1

        var prevUrl = createParamString(getParams({addPages: -increment}))
        var nextUrl = createParamString(getParams({addPages: increment}))
    		// var prevUrl = "?page=" + Math.max((basePageNum - increment), pageMin) + "&spread=" + isSpread
    		// var nextUrl = "?page=" + Math.min((basePageNum + increment), PageMax) + "&spread=" + isSpread

        document.getElementById("prev-link").href = prevUrl
        document.getElementById("next-link").href = nextUrl
      }

      function createParamString(params = {})
      {
        var paramString = Object.keys(params).reduce((acc, key) => {
          return acc + `&${key}=${params[key]}`
        }, "?")
        return paramString
      }

      function getParams(changes = {})
      {
        var page = changes.setPage || addPages(changes.addPages || 0);
        var spread = changes.isSpread == undefined ? isSpread : changes.isSpread
        
        return {
          page,
          spread
        }
      }

      function addPages(increment)
      {
        return Math.min(Math.max(basePageNum + increment, 0), PageMax);
      }

  		function createPage(index)
  		{
	  		var div = document.createElement("div")
	  		div.style = "height: 100%; width: 100%; display: flex; align-items: center; align-content: center; justify-content: center;"

	  		if (index < pageMin || index > PageMax)
	  		{
	  			return div
	  		}

	  		if (index == 4)
	  		{
	  			div.innerHTML = "<p>After the defeat of Emperor Palpatine and before Rey's trip to Tatooine...</p>"
	  			return div
	  		}

  			var src = "jpg/" + index.toString().padStart(2, "0") + ".jpg"
	  		var img = document.createElement("img")
	  		img.src = src
	  		img.setAttribute("class", "page")
	  		div.appendChild(img)
        return img
	  		return div
  		}

      function getClassString()
      {
        return `${isSpread ? "spread" : "single-page"} ${windowIsWiderThanLayout() ? "scale-to-height" : "scale-to-width"}`
      }

      function setPageHolderClass()
      {
        pageHolder.setAttribute("class", getClassString())
      }


  	</script>

  </body>

</html>