<!DOCTYPE html>

<html>

  <head>

    <title>Mementos: A Star Wars Fancomic by Clairemation</title>

    <style>

      p {
        font-size: 1.25em;
        font-family: sans-serif;
      }

      .page{
        flex: 0;
      }

      #page-holder.scale-to-height .page{
        height: 100%;
        width: auto;
      }

      #page-holder.scale-to-width .page{
        height: auto;
      }
       
      #page-holder.scale-to-width.spread .page {
        width: 50%;
      }

      #page-holder.scale-to-width.single-page .page{
        width: 100%;
      }

      #slidecontainer {
        width: 100%;
      }

      #slider {
        -webkit-appearance: none;
        width: 100%;
        height: 10px;
        background: #fff;
        outline: none;
      }

      #slider:hover {
        opacity: 1;
      }

      #slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 35px;
        height: 35px;
        border: 5px solid #444;
        border-radius: 50%;
        background: #999;
      }

      #slider::-moz-range-thumb {
        width: 25px;
        height: 25px;
        background: #4CAF50;
      }

    </style>

  </head>

  <body style = "text-align: center; background-color: #000; color: #fff; font-face: sans-serif;">

    <div id="container" style="position: absolute; left: 0; top: 0; width: 100%; height: 100%; display: flex; flex-direction: column;">

  		<div id = "page-holder" style = "position: relative; display: flex; flex-direction: row; align-content: center; align-items: center; justify-content: center; text-align: center; height: 100%; flex-shrink: 1;">

        <div id="nav-links" style="position: absolute; width: 100%; height: 100%;">
          <a id="prev-link"><div style="position: absolute; left: 0; top: 0; width: 50%; height: 100%;"> </div></a>
          <a id="next-link"><div style="position: absolute: right: 0; top: 0; width: 50%; height: 100%;"> </div></a>
        </div>

  		</div>

  		<div id="slidecontainer" style = "display:flex; flex-direction: row; align-items: center; align-content: center; justify-content: center; text-align: center; width: 100%;">
    		<div id = "displaybutton-holder" style = "display:flex; flex-direction: row; align-items: center; justify-content: center; text-align: center; height: 50px; width: 10%;">
    			<a id="display-button-anchor"><button id="display-button"></button></a>
    		</div>
        <input id="slider" type="range" min="1" max="40" value="1" class="html.slider" style= "-webkit-appearance: none; appearance: none; background: #fff; width: 80%;">
  		  <span id ="slider-output" style = "width: 10%; font-size: 1.25em; font-face: sans-serif; text-align: left;">1</span>
  		</div>

    </div>


  	<script>
      const meta = {
        title: "Mementos: A Star Wars Fancomic",
        pageWidth: 1350,
        pageHeight: 1800,
        pageMin: 0,
        pageMax: 41,
        complete: false,
        getImgUrl: index => `jpg/${index.toString().padStart(2, "0")}.jpg`,
        rawNumToDisplayNum: num => num <= 4 ? (["", "i", "ii", "cover", "note"])[num] : (num - 4).toString()
      }

      const html = {
        pageHolder: document.getElementById("page-holder"),
        slider: document.getElementById("slider"),
        sliderOutput: document.getElementById("slider-output"),
      }

  		const params = new URLSearchParams(window.location.search)
  		const basePageNum = parseInt(params.get("page")) || 1


      const display = (function() {
        var pageWidth = meta.pageWidth,
          pageHeight = meta.pageHeight
    		var pageAspect = () => pageWidth / pageHeight
    		var spreadAspect = () => pageWidth * 2 / pageHeight

    		function windowRatio()
        {
          return html.pageHolder.clientWidth / html.pageHolder.clientHeight
        }

    		function windowIsWiderThanSinglePage()
        {
          return windowRatio() >= pageAspect()
        }
    		
        function windowIsWiderThanSpread()
        {
          return windowRatio() >= spreadAspect()
        }

        function setPageDimensions(xyArray)
        {
          pageWidth = xyArray[0]
          pageHeight = xyArray[1]
        }

        return {
          windowIsWiderThanSinglePage,
          windowIsWiderThanSpread,
          setPageDimensions
        }
      })()

  		var isSpread

      init()
      initNavButtons()
      initDisplayToggle()
      initSlider()
      generatePageHTML()
      setPageHolderClass()


      var util = {
        throttleAndDebounceFunction: function(func, throttleDelay = 200, debounceDelay = 200)
        {
          var throttled = false
          var timeout
          return function(){
            if (!throttled)
            {
              setPageHolderClass()
              throttled = true
              setTimeout(() => {throttled = false}, throttleDelay)
            }
            clearTimeout(timeout)
            timeout = setTimeout(func, debounceDelay)
          }      
        }
      }
      
      window.onresize = window.onorientationchange = util.throttleAndDebounceFunction(setPageHolderClass)

      function init()
      {
    		if (params.has("spread"))
    		{
     			isSpread = params.get("spread") == "true" || false
    		}
    		else {
    			isSpread = display.windowIsWiderThanSpread()
    		}
      }

      function initDisplayToggle()
      {
        document.getElementById("display-button-anchor").href = createParamString(getParams({isSpread: !isSpread}))
        document.getElementById("display-button").innerHTML = isSpread ? "Display: single page" : "Display: spread"
      }

      function windowIsWiderThanLayout()
      {
        return (isSpread && (display.windowIsWiderThanSpread())) || (!isSpread && display.windowIsWiderThanSinglePage())
      }

      var pageNums
      function getSpreadPageNums(baseIndex)
      {
        // even on left, odd on right
        // return function(baseIndex)
        //   {
            if (pageNums == undefined)
            {
              var offsetFromLeft = baseIndex % 2 == 0
              pageNums = [baseIndex - (1 - offsetFromLeft), baseIndex + offsetFromLeft]
            }
            return pageNums
          }
      // })()

      function generatePageHTML(){
        var pageNums = isSpread ? getSpreadPageNums(basePageNum) : [basePageNum]
        for (var i = 0; i < pageNums.length; i++)
        {
          html.pageHolder.appendChild(createPage(pageNums[i]))
        }
      }

      function initSlider()
      {
    		if (isSpread)
    		{
          var pageStart = getSpreadPageNums(basePageNum)[0]
          var pageEnd = getSpreadPageNums(basePageNum)[1]
    			html.slider.min = 0
    			html.slider.max = meta.pageMax / 2
    			html.slider.value = pageStart / 2
    			if (html.slider.value == 0)
    			{
    				html.sliderOutput.innerHTML = meta.rawNumToDisplayNum(pageEnd)
    			} else {
  	  			html.sliderOutput.innerHTML = meta.rawNumToDisplayNum(pageStart) + "-" + meta.rawNumToDisplayNum(pageEnd)
  	  		}
    		}
    		else {
    			html.slider.min = 1
    			html.slider.max = meta.pageMax
    			html.slider.value = basePageNum
    			html.sliderOutput.innerHTML = meta.rawNumToDisplayNum(basePageNum)
    		}

        html.slider.oninput = isSpread ? updateSliderValueSpread : updateSliderValueSinglePage
        html.slider.onmouseup = (() => {
          var pageNum = isSpread ? html.slider.value * 2 : html.slider.value
          window.location.href = createParamString(getParams({setPage: pageNum}))
        })
      }

  		function updateSliderValueSpread()
  		{
  			var value = html.slider.value * 2
  			if (value == 0){
  				html.sliderOutput.innerHTML = meta.rawNumToDisplayNum(value + 1)
  			} else {
  			html.sliderOutput.innerHTML = meta.rawNumToDisplayNum(value) + "-" + meta.rawNumToDisplayNum(value + 1)
	  		}
        console.log(value)
  		}

  		function updateSliderValueSinglePage()
  		{
  			var value = html.slider.value
  			html.sliderOutput.innerHTML = meta.rawNumToDisplayNum(value)
  		}

  		function rawNumToDisplayNum(num)
  		{
  			if (num <=4)
  			{
  				return (["", "i", "ii", "cover", "note"])[num]
  			}
  			else {
  				return (num - 4).toString()
  			}
  		}

      function initNavButtons()
      {
    		var increment = isSpread ? 2 : 1
        var prevUrl = createParamString(getParams({addPages: -increment}))
        var nextUrl = createParamString(getParams({addPages: increment}))
        document.getElementById("prev-link").href = prevUrl
        document.getElementById("next-link").href = nextUrl
      }

      function createParamString(params = {})
      {
        var paramString = Object.keys(params).reduce((acc, key) => {
          return acc + `&${key}=${params[key]}`
        }, "?")
        return paramString
      }

      function getParams(changes = {})
      {
        var page = changes.setPage == undefined ? addPagesClamped(changes.addPages || 0) : changes.setPage;
        var spread = changes.isSpread == undefined ? isSpread : changes.isSpread
        
        return {
          page,
          spread
        }
      }

      function addPagesClamped(increment)
      {
        return Math.min(Math.max(basePageNum + increment, meta.pageMin), meta.pageMax);
      }

  		function createPage(index)
  		{

        return createPageImage(index)
  		}

      function createPageImage(index)
      {
        var src = meta.getImgUrl(index)
        var img = document.createElement("img")
        img.src = src
        img.setAttribute("class", "page")
        return img
      }

      function getPageHolderClassString()
      {
        return `${isSpread ? "spread" : "single-page"} ${windowIsWiderThanLayout() ? "scale-to-height" : "scale-to-width"}`
      }

      function setPageHolderClass()
      {
        html.pageHolder.setAttribute("class", getPageHolderClassString())
      }


  	</script>

  </body>

</html>